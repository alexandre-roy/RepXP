{% extends "site_web/base.html" %}
{% load static %}
{% block title %}
    <title>RepXP | Mon Profil</title>
{% endblock %}
{% block navigation %}
    <a href="{% url 'profile' %}" class="active-link">MON PROFIL</a>
    <a href="{% url 'edit_profile' %}" class="inactive-link">MODIFICATION DE PROFIL</a>
{% endblock %}
{% block main %}
    <div class="profile-container">
        <div class="profile-card">
            <div class="avatar-section">
                <img src="{{ user.avatar.url }}" class="rounded-circle" width="150" height="150">
                <h2 class="username">{{ user.username }}</h2>
            </div>

            <div class="equipped-badges">
                {% for eq in badges_equipes %}
                    <div class="equipped-slot">
                        {% if eq %}
                            <img src="{{ eq.badge.icone.url }}" class="equipped-img">
                        {% else %}
                            <img src="{% static 'images/empty_slot.png' %}" class="equipped-img">
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <div class="info-section">
                <h3>Informations personnelles</h3>
                <div class="info-grid">
                    <div><strong>Nom complet :</strong> {{ user.first_name }} {{ user.last_name }}</div>
                    <div><strong>Sexe :</strong>
                        {% if user.sexe == "M" %} Masculin
                        {% elif user.sexe == "F" %} Féminin
                        {% else %} Non spécifié {% endif %}
                    </div>
                    <div><strong>Date de naissance :</strong> {{ user.date_naissance|date:"d/m/Y" }}</div>
                    <div><strong>Taille :</strong>
                        {% if user.taille %} {{ user.taille }} m
                        {% else %} Non spécifié {% endif %}
                    </div>
                    <div><strong>Poids :</strong>
                        {% if user.poids %} {{ user.poids }} kg
                        {% else %} Non spécifié {% endif %}
                    </div>
                    <div><strong>Adresse courriel :</strong>
                        {% if user.email %} {{ user.email }}
                        {% else %} Non spécifié {% endif %}
                    </div>
                </div>
            </div>

            <div class="info-section">
                <h3>Statistiques</h3>
                <div class="info-grid">
                    <div><strong>Séries effectuées :</strong> {{ stats.sets_effectues }}</div>
                    <div><strong>Répétitions effectuées :</strong> {{ stats.reps_effectuees }}</div>
                    <div><strong>Exercices complétés :</strong> {{ stats.exercices_completes }}</div>
                    <div><strong>Entraînements complétés :</strong> {{ stats.entrainements_completes }}</div>
                    <div><strong>Badges obtenus :</strong> {{ badges_obtenus.count }} </div>
                </div>
            </div>

            <div class="info-section">
                <h3>Badges obtenus</h3>

                {% regroup badges_obtenus by badge.categorie as badges_par_categorie %}
                {% if badges_par_categorie %}
                    {% for groupe in badges_par_categorie %}
                        <h5 class="badge-category-title">{{ groupe.grouper }}</h5>

                        <div class="badges-grid">
                            {% for b in groupe.list %}
                                <div class="badge-card"
                                    data-badge-id="{{ b.badge.id }}"
                                    data-bs-toggle="popover"
                                    data-bs-title="{{ b.badge.nom }}"
                                    data-bs-content="{{ b.badge.description }}"
                                    data-bs-placement="top">
                                    <img src="{{ b.badge.icone.url }}" class="badge-img">
                                    <div class="badge-name">{{ b.badge.nom }}</div>
                                    <div class="badge-date">
                                        Obtenu le {{ b.date_obtenu|date:"d/m/Y" }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p>Aucun badge obtenu pour le moment.</p>
                {% endif %}
            </div>


        </div>
    </div>



<script>
document.addEventListener("DOMContentLoaded", function () {

    document.querySelectorAll('[data-bs-toggle="popover"]').forEach(el => {
        new bootstrap.Popover(el, {
            trigger: 'hover',
            html: true
        });
    });

    document.querySelectorAll(".badge-card[data-badge-id]").forEach(card => {
        card.addEventListener("click", function () {
            const badgeId = this.dataset.badgeId;
            let slot = prompt("Dans quel emplacement voulez-vous équiper ce badge ? (1, 2 ou 3)");

            slot = parseInt(slot);
            if (![1, 2, 3].includes(slot)) return;

            fetch(`/profile/equiper_badge/${badgeId}/${slot}/`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert("Impossible d’équiper ce badge.");
                    }
                });
        });
    });


});
</script>
{% endblock %}
