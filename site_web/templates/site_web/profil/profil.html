{% extends "site_web/base.html" %}
{% load static %}
{% block title %}
    <title>RepXP | Mon Profil</title>
{% endblock %}
{% block navigation %}
    <a href="{% url 'profile' %}" class="active-link">MON PROFIL</a>
    <a href="{% url 'edit_profile' %}" class="inactive-link">MODIFICATION DE PROFIL</a>
{% endblock %}
{% block main %}
    <div class="profile-container">
        <div class="profile-card">
            <div class="avatar-section">
                <img src="{{ user.avatar.url }}" class="rounded-circle" width="150" height="150">
                <h2 class="username">{{ user.username }}</h2>
            </div>

            <div class="equipped-badges">
                {% for eq in badges_equipes %}
                    <div class="equipped-slot">
                        {% if eq %}
                            <img src="{{ eq.badge.icone.url }}" class="equipped-img">
                        {% else %}
                            <img src="{% static 'images/empty_slot.png' %}" class="equipped-img">
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <div class="info-section">
                <h3>Informations personnelles</h3>
                <div class="info-grid">
                    <div><strong>Nom complet :</strong> {{ user.first_name }} {{ user.last_name }}</div>
                    <div><strong>Sexe :</strong>
                        {% if user.sexe == "M" %} Masculin
                        {% elif user.sexe == "F" %} Féminin
                        {% else %} Non spécifié {% endif %}
                    </div>
                    <div><strong>Date de naissance :</strong> {{ user.date_naissance|date:"d/m/Y" }}</div>
                    <div><strong>Taille :</strong>
                        {% if user.taille %} {{ user.taille }} m
                        {% else %} Non spécifié {% endif %}
                    </div>
                    <div><strong>Poids :</strong>
                        {% if user.poids %} {{ user.poids }} kg
                        {% else %} Non spécifié {% endif %}
                    </div>
                    <div><strong>Adresse courriel :</strong>
                        {% if user.email %} {{ user.email }}
                        {% else %} Non spécifié {% endif %}
                    </div>
                </div>
            </div>

            <div class="info-section">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <h3 class="mb-0">Statistiques</h3>

                    <button id="refresh-stats" class="btn btn-light p-2 rounded-circle shadow-sm"
                            title="Actualiser les statistiques">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                </div>
                <div class="info-grid">
                    <div><strong>Séries effectuées :</strong> <span id="stats-sets">{{ stats.sets_effectues }}</span></div>
                    <div><strong>Répétitions effectuées :</strong> <span id="stats-reps">{{ stats.reps_effectuees }}</span></div>
                    <div><strong>Exercices complétés :</strong> <span id="stats-ex">{{ stats.exercices_completes }}</span></div>
                    <div><strong>Entraînements complétés :</strong> <span id="stats-ent">{{ stats.entrainements_completes }}</span></div>
                    <div><strong>Badges obtenus :</strong> <span id="stats-bad">{{ stats.badges_obtenus }}</span></div>
                    <div><strong>Défis complétés :</strong> <span>{{ nb_defis }}</span></div>
                </div>
            </div>

            <div class="info-section">
                <h3>Badges obtenus</h3>

                {% regroup badges_obtenus by badge.categorie as badges_par_categorie %}
                {% if badges_par_categorie %}
                    {% for groupe in badges_par_categorie %}
                        <h5 class="badge-category-title">{{ groupe.grouper }}</h5>

                        <div class="badges-grid">
                            {% for b in groupe.list %}
                                <div class="badge-card"
                                    data-badge-id="{{ b.badge.id }}"
                                    data-bs-toggle="popover"
                                    data-bs-title="{{ b.badge.nom }}"
                                    data-bs-content="{{ b.badge.description }}"
                                    data-bs-placement="top">
                                    <img src="{{ b.badge.icone.url }}" class="badge-img">
                                    <div class="badge-name">{{ b.badge.nom }}</div>
                                    <div class="badge-date">
                                        Obtenu le {{ b.date_obtenu|date:"d/m/Y" }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p>Aucun badge obtenu pour le moment.</p>
                {% endif %}
            </div>


        </div>
    </div>


    <div class="modal fade slot-select-modal" id="slotSelectModal" tabindex="-1" aria-labelledby="slotSelectLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-blue shadow-form">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="slotSelectLabel">Choisir un emplacement pour le badge</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Dans quels emplacements voulez-vous équiper ce badge&nbsp;?</p>
                    <div class="d-flex justify-content-center gap-3">
                        <button type="button" class="style-button slot-choice-btn" data-slot="1">
                            Slot&nbsp;1
                        </button>
                        <button type="button" class="style-button slot-choice-btn" data-slot="2">
                            Slot&nbsp;2
                        </button>
                        <button type="button" class="style-button slot-choice-btn" data-slot="3">
                            Slot&nbsp;3
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script>
        const refreshStatsUrl = "{% url 'ajax_statistiques' %}";
    </script>

    <script src="{% static 'site_web/js/profil.js' %}"></script>


    <script>
        document.addEventListener("DOMContentLoaded", function () {

            document.querySelectorAll('[data-bs-toggle="popover"]').forEach(el => {
                new bootstrap.Popover(el, {
                    trigger: 'hover',
                    html: true
                });
            });

            const slotModalEl = document.getElementById("slotSelectModal");
            const slotModal = new bootstrap.Modal(slotModalEl);
            let selectedBadgeId = null;

            document.querySelectorAll(".badge-card[data-badge-id]").forEach(card => {
                card.addEventListener("click", function () {
                    selectedBadgeId = this.dataset.badgeId;
                    slotModal.show();
                });
            });

            slotModalEl.querySelectorAll(".slot-choice-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    if (!selectedBadgeId) {
                        return;
                    }

                    const slot = parseInt(this.dataset.slot, 10);
                    if (![1, 2, 3].includes(slot)) {
                        return;
                    }

                    fetch(`/profile/equiper_badge/${selectedBadgeId}/${slot}/`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                location.reload();
                            } else {
                                alert("Impossible d’équiper ce badge.");
                            }
                        })
                        .finally(() => {
                            slotModal.hide();
                            selectedBadgeId = null;
                        });
                });
            });
        });
    </script>
{% endblock %}
